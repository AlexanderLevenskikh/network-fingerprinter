# Network fingerprinter

> Network fingerprinter - масштабируемая, простая в развертывании система анализа трафика для пассивной идентификации ОС и приложений

*Документация на других языках: [Русский](README.ru.md), [Английский](README.md).*

## Table of Contents

- [Назначение](#назначение)
- [Архитектура системы](#архитектура-системы)
	- [Сенсор](#сенсор)
	- [Коллектор](#коллектор)
	- [Анализатор](#анализатор)
- [Установка](#установка)
- [Сигнатурный анализ](#сигнатурный-анализ)

## Назначение
Хорошо известные системы фингерпринтинга, такие как p0f, satori, и т. д. достаточно функциональны, но имеют некоторые недостатки при использовании в production: 
* Затруднительное отслеживание предпрупреждений при значительном объеме трафика
* Для пассивной идентификации ОС и приложений нет необходимости хранить весь дамп трафика, за исключением некоторых типов пакетов в контексте потока: TCP SYN/SYN+ACK, TLS Client Hello, и других необходимых для сигнатурного анализа примеров. Потоки - хорошее решение, но существующие решения предлагают либо сохранять весь дамп, либо только алерты
* Отсутствие графического интерфейса
* Сложный процесс настройки для production-использования

## Архитектура системы

Система состоит из следующего набора модулей:
* [Сенсор](#сенсор)
* [Коллектор](#коллектор)
* [Анализатор](#анализатор)

#### Сенсор 

Сенсор работает поверх tshark, который выборочно экспортирует трафик. Экспортируются пакеты типа SYN, SYN+ACK, TLS Client Hello, HTTP запрос/ответ в индекс **elasticsearch**. Система может иметь более одного сенсора.

#### Коллектор

Коллектор - это кластер **elasticsearch**. Аналогично, может быть настроено более одного коллектора.

#### Анализатор

Анализатор - графический интерфейс **kibana** для анализа индекса **packets-\*** и **analytics-app** - модуль сигнатурного анализа с графическим интерфейсом. Также, в **analytics-app** можно загружать дампы ранее захваченного трафика (в форматах, распознаваемых tshark, к примеру - pcap[ng]).

> Все компоненты системы можно установить на одном хосте

## Установка

Каждый модуль содержит файл `.env`, используемый **docker-compose** конфигурацией и приложением **analytics-app**. Для корректной работы, необходимо заменить данные в этих файлах в соответствии с сетевой топологией.

##### 1. Установка модуля коллектора:
Вам следует создать директорию, в которой elasticsearch будет сохранять данные.
По умолчанию это директория `collector/data`.

Для этого необходимо в разделе `volumes`, строке `device` файла `docker-compose` указать абсолютный путь к данной директории:
```
volumes:
  elasticsearch:
    driver_opts:
      type: none
      **device: $PWD/data**
      o: bind
```
Также следует убедиться, что директория по данному пути существует.\
Либо можно удалить раздел `driver_opts`, если нет необходимости в в обращении к данной директории.\
Далее можно запустить `docker-compose` в detached-режиме:
```
docker-compose up --build -d 
```

##### 2. Установка и запуск сенсора:

Сенсор зависит от elasticsearch, но не обязательно ждать, когда elasticsearch запустится, т.к. запуск сенсора осуществляется повторно при возникновении ошибки соедения. Перед установкой достаточно отредактировать `.env`-файл в директории `sensor` и далее `docker-compose up --build -d`

##### 3. Установка и запуск анализатора:

Аналогично, перед установкой нужно отредактировать `.env`-файл, создать директорию для хранения данных PostgreSQL, либо удалить `driver_opts` как в шаге с установкой коллектора и запустить `docker-compose up --build -d ` в директории `analytics-app`. В первую очередь, будет произведен запуск PostgreSQL, затем - сам анализатор.\
**Kibana** доступна по адресу `http://${host}:5601`,
**Analytics-app** доступен по адресу `http://${host}:3000`, где `host` - ip/доменное имя хоста, на котором установлен анализатор. 

## Сигнатурный анализ

Логин/пароль по умолчанию: **root**/**root**

Приложение содержит 3 раздела:
* TCP-потоки
* Статистика
* Загрузка файлов \*.pcap

Первый раздел отображает список потоков с возможностью сортировки/поиска:
![Streams list](https://i.imgur.com/KlkwxKp.png)

Фильтрация доступна по нажатию на кнопку "Поиск":
![Filter](https://i.imgur.com/X5O27Zy.png)

Для сохранения данных в буфер обмена (для последующей фильтрации, к примеру), нажмите на кнопку "копировать" около данных:
![Copy](https://i.imgur.com/CEoOfhZ.png)

Описание колонок:
* Первая колонка содержит **общие данные** о потоке:
	* **SNI** (server name indication из tls-заголовков, если расширение было использовано)
	* **Протоколы прикладного уровня** - список всех протоколов прикладного уровня, которые были найдены в потоке
* **Дата и время** - временная отметка первого обнаруженного пакета в потоке (обычно это SYN, но может быть HTTP-пакетом, либо TLS Client Hello)
* **MAC, IP, Порт.** Источник - хост, инициирующий TCP-соединение (клиент) и назначение - хост, принимающий соединение (сервер), но, как известно, TCP является полнодуплексным протколом, поэтому названия "клиент" и "сервер" являются условными.
* **Цифровой отпечаток** - вычисленные отпечатки потока, они могут включать в себя TCP-, TLS- и HTTP-отпечатки для клиента (по SYN, HTTP-запросу и TLS client hello) и TCP-, HTTP-отпечатки для сервера (по SYN+ACK, HTTP-ответу)

Меню статистики содержит пункты "по клиентам" и "по серверам":
![stat-tabs](https://i.imgur.com/CoGpUNB.png)

В каждой вкладке расположена список кортежей (ip, mac), обнаруженных в сетевом трафике.
![by-clients](https://i.imgur.com/FBhRkMb.png)

Каждая строка кликабельна и при нажатии можно посмотреть более детальную информацию про выбранный хост (открывается боковая страница):
![drawer](https://i.imgur.com/JKTtCAw.png)
Как можно заметить, эта информация включает в себя все отпечатки, обнаруженные по потокам; ссылку на отфильтрованный список потоков. Также, в данном примере показан случай обнаружения более, чем 1 отпечатка (TLS) и вхождение отпечатков в черный список (Dridex, Tofsee).

Загрузка файлов захвата трафика:
[pcap-upload](https://i.imgur.com/dTQf184.png)
Доступна загрузка более 1 файла. Для этого достаточно перетащить в выделенную область набор файлов, либо нажать на область и выбрать их в проводнике. После обработки, потоки будут доступны на вкладке TCP-потоки, если дамп содержит значимые пакеты (SYN, SYN+ACK, HTTP-запрос/ответ или TLS Client Hello) 

Управление пользователями:
[user-mgmt](https://i.imgur.com/3qJEz9w.png)
После первого входа под пользователем **root** следует создать учетную запись администратора и удалить пользователя **root**

## Лицензия
Apache 2.0-лицензия. Подробности в [LICENSE](LICENSE)
